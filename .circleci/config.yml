# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
orbs:
  docker: circleci/docker@1.7

commands:
  build-image:
    parameters:
      image-target:
        type: enum
        default: "build-image"
        enum: ["build-image", "build-image-test"]
      image-tags:
        type: string
        default: "${CIRCLE_SHA1}"
      squash:
        type: string
        default: ""
    steps:
      - setup_remote_docker:
          docker_layer_caching: true
          version: 20.10.7
      - checkout
      - run:
          name: Docker version
          command: docker version
      # - run:
      #     name: build
      #     command: docker build --build-arg NF_IMAGE_VERSION=${CIRCLE_SHA1} -t netlify/build:${CIRCLE_SHA1} .
      - docker/build:
          image: netlify/build
          extra_build_args: "--build-arg NF_IMAGE_VERSION=${CIRCLE_SHA1} --target << parameters.image-target >> << parameters.squash >>"
          tag: << parameters.image-tags >>

jobs:
  build-image:
    docker:
      - image: cimg/base:2021.04
    steps:
      - run:
          name: Sanitize branch name
          command: echo export "BRANCH=${CIRCLE_BRANCH//\//-}" >> "$BASH_ENV"
      - build-image:
          image-target: "build-image"
          image-tags: "${CIRCLE_SHA1},${BRANCH}"
      - run:
          command: docker save netlify/build:${CIRCLE_SHA1} -o /tmp/images/build-image
      - persist_to_workspace:
          root: /tmp/images
          paths:
            - build-image

  run-tests:
    docker:
      - image: cimg/base:2021.04
    steps:
      - run:
          name: Sanitize branch name
          command: echo export "BRANCH=${CIRCLE_BRANCH//\//-}" >> "$BASH_ENV"
      - attach_workspace:
          at: /tmp/images
      - run:
          command: docker load -i /tmp/images/build-image
      - build-image:
          image-target: "build-image-test"
          image-tags: "${CIRCLE_SHA1}-test,${BRANCH}-test"
      - run:
          name: Run Tests
          command: docker run --rm netlify/build:${CIRCLE_SHA1}-test

  build-and-push:
    docker:
      - image: cimg/base:2021.04
    steps:
      - run:
          name: Sanitize branch name
          command: echo export "BRANCH=${CIRCLE_BRANCH//\//-}" >> "$BASH_ENV"
      - build-image:
          image-target: "build-image"
          image-tags: "${CIRCLE_SHA1},${BRANCH}"
      # - run:
      #     name: Tag
      #     command: |
      #       docker tag netlify/build:$

  lint:
    executor: docker/machine
    steps:
      - checkout
      - docker/dockerlint


workflows: # workflows are where we specify the job order and job parameters (if applicable)
  test-build:
    jobs:
      - build-image
      - run-tests:
          requires: [build-image]
      # - build-and-push:
      #     requires: [run-tests, lint]
      - lint
