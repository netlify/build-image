# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
orbs:
  docker: circleci/docker@1.7

commands:
  build-image:
    parameters:
      image-target:
        type: enum
        default: "build-image"
        enum: ["build-image", "build-image-test"]
      image-tag:
        type: string
        default: ${CIRCLE_SHA1}
    steps:
      - setup_remote_docker:
          docker_layer_caching: true
          version: 20.10.7
      - checkout
      - run:
          name: Sanitize branch name
          command: echo export "BRANCH=${CIRCLE_BRANCH//\//-}" >> "$BASH_ENV"
      - run:
          name: Docker version
          command: docker version
      # - run:
      #     name: build
      #     command: docker build --build-arg NF_IMAGE_VERSION=${CIRCLE_SHA1} -t netlify/build:${CIRCLE_SHA1} .
      - docker/build:
          image: netlify/build
          extra_build_args: "--build-arg NF_IMAGE_VERSION=${CIRCLE_SHA1} --target << parameters.image-target >>"
          tag: << parameters.image-tag >>


jobs:
  run-tests:
    docker:
      - image: cimg/base:2021.04
    steps:
      - build-image:
          image-target: "build-image-test"
      - run:
          name: Run Tests
          command: docker run --rm netlify/build:${CIRCLE_SHA1}

  lint:
    executor: docker/machine
    steps:
      - checkout
      - docker/dockerlint


workflows: # workflows are where we specify the job order and job parameters (if applicable)
  test-build:
    jobs:
      - run-tests:
          name: Run Tests
      - lint
